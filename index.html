<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notion Clone</title>
  <link rel="stylesheet" href="style.css" />
</head>
<script src="main.js"></script>
<body>

  <!-- ë¬¸ì„œ ìƒì„± ë²„íŠ¼ -->
  <button id="create-document-btn">â• ìƒˆ ë¬¸ì„œ ë§Œë“¤ê¸°</button>

  <!-- ì—ë””í„° ì˜ì—­ -->
  <div id="editor-container">
    <input id="document-title" placeholder="ë¬¸ì„œ ì œëª©" />
    <textarea id="document-content" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
  </div>

  <script>
    // ë¬¸ì„œ ID ì¶”ì¶œ
    let documentId = window.location.pathname.split("/")[2];

    // ID ì—†ê±°ë‚˜ ìˆ«ì ì•„ë‹ˆë©´ ê°•ì œë¡œ /documents/1 ë¡œ ì´ë™
    if (!documentId || isNaN(documentId)) {
      documentId = "1";
      history.replaceState({}, "", `/documents/${documentId}`);
    }

    // debounce í•¨ìˆ˜
    function debounce(callback, delay = 1000) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => callback(...args), delay);
      };
    }

    // ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadDocument(id) {
      try {
        const res = await fetch(`https://kdt-api.fe.dev-cos.com/documents/${id}`, {
          headers: {
            "x-username": "kyeong_rok"
          }
        });

        if (!res.ok) throw new Error("ë¬¸ì„œ ì—†ìŒ");

        const data = await res.json();
        document.querySelector("#document-title").value = data.title || "";
        document.querySelector("#document-content").value = data.content || "";
      } catch (e) {
        console.error("ë¬¸ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
      }
    }

    // ë¬¸ì„œ ì €ì¥í•˜ê¸°
    const saveDocument = debounce(async () => {
      const title = document.querySelector("#document-title").value;
      const content = document.querySelector("#document-content").value;

      try {
        const res = await fetch(`https://kdt-api.fe.dev-cos.com/documents/${documentId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "x-username": "kyeong_rok"
          },
          body: JSON.stringify({ title, content })
        });

        console.log("ğŸ’¾ ì €ì¥ ì™„ë£Œ!");
      } catch (e) {
        console.error("ì €ì¥ ì‹¤íŒ¨:", e);
      }
    }, 1000);

    // ì´ë²¤íŠ¸ ì—°ê²°
    document.querySelector("#document-title").addEventListener("input", saveDocument);
    document.querySelector("#document-content").addEventListener("input", saveDocument);

    // ì´ˆê¸° ë¡œë”©
    loadDocument(documentId);

    // ë¬¸ì„œ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ
    document.querySelector("#create-document-btn").addEventListener("click", async () => {
      try {
        const res = await fetch("https://kdt-api.fe.dev-cos.com/documents", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-username": "kyeong_rok"
          },
          body: JSON.stringify({
            title: "ìƒˆ ë¬¸ì„œ",
            parent: null
          })
        });

        const data = await res.json();
        const newId = data.id;

        // ìƒˆ ë¬¸ì„œë¡œ ì´ë™
        history.pushState({}, "", `/documents/${newId}`);
        window.location.reload();
      } catch (e) {
        console.error("ë¬¸ì„œ ìƒì„± ì‹¤íŒ¨!", e);
      }
    });
  </script>

</body>
</html>
